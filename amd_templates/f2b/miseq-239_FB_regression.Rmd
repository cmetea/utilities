---
title: "MiSeq-239"
output:
  html_notebook:
    df_print: paged
    number_sections: yes
    theme: lumen
    toc: yes
    code_folding: hide
---

<style>
  html {
    font-size: 16pt;
  }
  
  body {
    font-size: 16pt;
  }
  
  h1 {
    font-size: 2.2rem;
  }
  
  h2 {
    font-size: 2rem;
  }
  
  h3 {
    font-size: 1.8rem;
  }
  
  h4 {
    font-size: 1.4rem;
  }
  
</style>

# F B Analysis: Regression {.tabset}

## Setup {.tabset}

### [Close]

### Start Conda ENV
```{r}
startCondaEnv('alphadiv')
```

### Set Knitr Options
```{r}
library(rmarkdown)
library(knitr)

opts_chunk$set(
  echo=TRUE,
  dpi=300,
  fig.width=12
  )
```

### Load Libraries
```{r}
library(tidyverse)
library(magrittr)
library(ggplot2)
library(ggbeeswarm)
library(openxlsx)
library(DT)
library(pheatmap)
library(kableExtra)
library(vegan)
library(nlme)

### Custom libraries that can be loaded from GitHub
source('~/utilities/analysis-utilities/general_asv_data_analysis_utilities.R')
source('~/utilities/analysis-utilities/alpha_div_utilities.R')
```


### Set Paths
```{r}
project_dir = "~/miseq-239"
dada2_table_dir = file.path(project_dir, "processed_data")
metadata_dir = file.path(project_dir, "metadata")
analysis_dir = file.path(project_dir, 'analysis/f2b_ratio')
tables_dir = file.path(analysis_dir, 'tables')
```

### Load Data
```{r}
fb_master_table = read.xlsx(file.path(tables_dir, 'miseq-239_F_B_master_table.xlsx'))
age_lt_90_master_table = fb_master_table %>% filter(Age<90)
amd_only_master_table = fb_master_table %>% filter(CaseString=='AMD')

sample_metadata = read.delim(
  file.path(metadata_dir, 'miseq-239_metadata_CNV_GA.tsv'), 
  stringsAsFactors=F
  )
```


### Variables of interest
```{r}
variables_of_interest = list(
  CaseString = list(
    covariate_of_interest='CaseString',
    control='Control',
    case='AMD',
    lables=list(reference='Control', comparison='AMD')
  ),
  ARMS2rs10490924 = list(
    covariate_of_interest='ARMS2rs10490924',
    control='GG',
    case='TT',
    labels=list(reference='Non-Risk', comparison='Risk')
    ),
  CFHrs1061170 = list(covariate_of_interest='CFHrs1061170',
    control='TT',
    case='CC',
    labels=list(reference='Non-Risk', comparison='Risk')
    ),
  CFHrs10737680 = list(
    covariate_of_interest='CFHrs10737680',
    control='CC',
    case='AA',
    labels=list(reference='Non-Risk', comparison='Risk')
    ),
  SKIV2Lrs429608 = list(
    covariate_of_interest='SKIV2Lrs429608',
    control='AA',
    case='GG',
    labels=list(reference='Non-Risk', comparison='Risk')
    ),
  GA_No_CNV_Either_Eye = list(
    covariate_of_interest='GA_No_CNV_Either_Eye',
    control=0,
    case=1,
    labels=list(reference='Healthy', comparison='Disease')
    ),
  CNV_Either_Eye = list(
    covariate_of_interest='CNV_Either_Eye',
    control=0,
    case=1,
    labels=list(reference='Healthy', comparison='Disease')
    ),
  Age = list(
    covariate_of_interest='Age',
    control='',
    case=''
    ),
  Gender = list(
    covariate_of_interest='Gender',
    control='F',
    case='M',
    labels=list(reference='F', comparison='M')
    ),
  AREDS = list(
    covariate_of_interest='AREDS',
    control='N',
    case='Y',
    labels=list(reference='N', comparison='Y')
    )
  )
```


### Set Factor Levels
```{r}
setFactors = function(df)
{
  for (var in variables_of_interest)
  {
    name = var$covariate_of_interest
    case = var$case
    control = var$control
    # print(sprintf('name: %s, case: %s, control: %s', name, case, control))
  
    if (case != '' & control != '')
    {
      # print('ok')
      df = mutate(df, !!name := factor(!!as.name(name), levels=c(control, case)))
    }
  
  }
  
  return(df)
}

fb_master_table = setFactors(fb_master_table)
age_lt_90_master_table = setFactors(age_lt_90_master_table)
amd_only_master_table = setFactors(amd_only_master_table)
sample_metadata = setFactors(sample_metadata)

```


### Determine which covariates have sufficient samples with each value
```{r}
filterVarsBySampleThreshold = function(master_table, threshold, variable_list)
{
  new_variable_list = list()
  
  for (var in variable_list)
  {
    name = var$covariate_of_interest
    case = var$case %>% as.character()
    control = var$control %>% as.character()
    print(sprintf('name: %s, case: %s, control: %s', name, case, control))
    
    ### Ignore if not in master table
    if (!(name %in% colnames(master_table)))
    {
      # print("next")
      next
    }
    
    ### to deal with continuous covariate such as Age
    if (case=="" & control=="")
    {
      ### Always allow
      # print("got continuous variable")
      num_case_samples = 99999
      num_control_samples = 99999
    } else
    {
      count_table = 
        master_table %>%
        pull(!!name) %>%
        table()
      num_case_samples = count_table[[case]]
      num_control_samples = count_table[[control]]
      # print(count_table)
    }
    
    print(sprintf('case samples: %d, control samples: %d', num_case_samples, num_control_samples))
    
    if (num_case_samples >= num_samples_threshold & num_control_samples >= num_samples_threshold)
    {
      # print("adding var")
      # print(var)
      new_variable_list[[name]] = var
      # print(names(new_variable_list))
    }
  }

  
  return(new_variable_list)
}

num_samples_threshold = 5

all_variables = filterVarsBySampleThreshold(
  fb_master_table, 
  num_samples_threshold,
  variables_of_interest
  )

age_lt_90_variables = filterVarsBySampleThreshold(
  age_lt_90_master_table, 
  num_samples_threshold,
  variables_of_interest
  )

amd_only_variables = filterVarsBySampleThreshold(
  amd_only_master_table %>% select(-CaseString), 
  num_samples_threshold,
  variables_of_interest
  )


all_formula_rhs = paste0(names(all_variables), collapse=' + ')
age_lt_90_formula_rhs = paste0(names(age_lt_90_variables), collapse=' + ')
amd_only_formula_rhs = paste0(names(amd_only_variables), collapse=' + ')
```


### Create p-val names for contrasts

```{r}
pval_names = lapply(all_variables, function(x)
{
  pval_name = paste0(x$covariate_of_interest, x$case)
})

pval_names
```

### Initialize regression stats table

```{r}
regression_stats = data.frame(
  Index=character()
)

for (var in all_variables)
{
  name = var$covariate_of_interest
  print(name)
  regression_stats = regression_stats %>% mutate(!!var$covariate_of_interest := numeric())
}

all_regression_stats = regression_stats
age_lt_90_regression_stats = regression_stats
amd_only_regression_stats = regression_stats

adjusted_regression_stats = regression_stats
```

## Linear Regression {.tabset}

### All

#### Firmicutes
```{r}
firmicutes_rank_all = lm(
  paste0('rank(Firmicutes) ~ ', all_formula_rhs) %>% as.formula,
  data=fb_master_table
  )
rank_fit_summary = summary(firmicutes_rank_all)
# print(rank_fit_summary)

firmicutes_rank_pvals = sapply(names(all_variables), function(name)
  {
    print(name)
    contrast_name = pval_names[[name]]
    print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
)

firmicutes_rank_pvals = c(list(Index='All_Firmicutes_Rank'), firmicutes_rank_pvals)

all_regression_stats %<>%
  add_row(!!!firmicutes_rank_pvals)


# kable(bacteroidetes_all_pvals %>% round(3))
```

#### Bacteroidetes
```{r}
bacteroidetes_rank_all = lm(
  paste0('rank(Bacteroidetes) ~ ',all_formula_rhs) %>% as.formula,
  data=fb_master_table
  )
rank_fit_summary = summary(bacteroidetes_rank_all)
print(rank_fit_summary)

bacteroidetes_rank_pvals = sapply(names(all_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

bacteroidetes_rank_pvals = c(list(Index='All_Bacteroidetes_Rank'), bacteroidetes_rank_pvals)

all_regression_stats %<>%
  add_row(!!!bacteroidetes_rank_pvals)

# kable(bacteroidetes_all_pvals %>% round(3))
```

#### F2B_Ratio
```{r}
F2B_Ratio_rank_all = lm(
  paste0('rank(F2B_Ratio) ~ ',all_formula_rhs) %>% as.formula,
  data=fb_master_table
  )
rank_fit_summary = summary(F2B_Ratio_rank_all)
# print(rank_fit_summary)

F2B_Ratio_rank_pvals = sapply(names(all_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

F2B_Ratio_rank_pvals = c(list(Index='All_F2B_Ratio_Rank'), F2B_Ratio_rank_pvals)

all_regression_stats %<>%
  add_row(!!!F2B_Ratio_rank_pvals)


# kable(bacteroidetes_all_pvals %>% round(3))
```


#### LogF2B_Ratio
```{r}
LogF2B_Ratio_rank_all = lm(
  paste0('rank(F2B_Ratio) ~ ',all_formula_rhs) %>% as.formula,
  data=fb_master_table
  )
rank_fit_summary = summary(LogF2B_Ratio_rank_all)
# print(rank_fit_summary)

LogF2B_Ratio_rank_pvals = sapply(names(all_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

F2B_Ratio_rank_pvals = c(list(Index='All_LogF2B_Ratio_Rank'), LogF2B_Ratio_rank_pvals)

all_regression_stats %<>%
  add_row(!!!LogF2B_Ratio_rank_pvals)

```



#### FB_Index
```{r}
FB_Index_rank_all = lm(
  paste0('rank(F2B_Ratio) ~ ',all_formula_rhs) %>% as.formula,
  data=fb_master_table
  )
rank_fit_summary = summary(FB_Index_rank_all)
# print(rank_fit_summary)

FB_Index_rank_pvals = sapply(names(all_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

F2B_Ratio_rank_pvals = c(list(Index='All_FB_Index_Rank'), FB_Index_rank_pvals)

all_regression_stats %<>%
  add_row(!!!FB_Index_rank_pvals)

```



```{r eval=F}
# print(regression_stats)
# 
# adjusted_regression_stats = 
#   regression_stats %>%
#   mutate(
#     CaseString = p.adjust(CaseString, method='fdr'), 
#     Age=p.adjust(Age, method='fdr'), 
#     Gender=p.adjust(Gender, method='fdr'), 
#     AREDS=p.adjust(AREDS, method='fdr')
#   )
# 
# print(adjusted_regression_stats)
# kable(adjusted_regression_stats) %>% kable_styling()
```

### Age < 90

#### Firmicutes
```{r}
firmicutes_rank_all = lm(
  paste0('rank(Firmicutes) ~ ', age_lt_90_formula_rhs) %>% as.formula,
  data=age_lt_90_master_table
  )
rank_fit_summary = summary(firmicutes_rank_all)
# print(rank_fit_summary)

firmicutes_rank_pvals = sapply(names(age_lt_90_variables), function(name)
  {
    print(name)
    contrast_name = pval_names[[name]]
    print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
)

firmicutes_rank_pvals = c(list(Index='Age_lt_90_Firmicutes_Rank'), firmicutes_rank_pvals)

age_lt_90_regression_stats %<>%
  add_row(!!!firmicutes_rank_pvals)


# kable(bacteroidetes_all_pvals %>% round(3))
```

#### Bacteroidetes
```{r}
bacteroidetes_rank_all = lm(
  paste0('rank(Bacteroidetes) ~ ', age_lt_90_formula_rhs) %>% as.formula,
  data=age_lt_90_master_table
  )
rank_fit_summary = summary(bacteroidetes_rank_all)
print(rank_fit_summary)

bacteroidetes_rank_pvals = sapply(names(amd_only_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

bacteroidetes_rank_pvals = c(list(Index='Age_lt_90_Bacteroidetes_Rank'), bacteroidetes_rank_pvals)

age_lt_90_regression_stats %<>%
  add_row(!!!bacteroidetes_rank_pvals)

# kable(bacteroidetes_all_pvals %>% round(3))
```

#### F2B_Ratio
```{r}
F2B_Ratio_rank_all = lm(
  paste0('rank(F2B_Ratio) ~ ', age_lt_90_formula_rhs) %>% as.formula,
  data=age_lt_90_master_table
  )
rank_fit_summary = summary(F2B_Ratio_rank_all)
# print(rank_fit_summary)

F2B_Ratio_rank_pvals = sapply(names(amd_only_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

F2B_Ratio_rank_pvals = c(list(Index='Age_lt_90_F2B_Ratio_Rank'), F2B_Ratio_rank_pvals)

age_lt_90_regression_stats %<>%
  add_row(!!!F2B_Ratio_rank_pvals)


# kable(bacteroidetes_all_pvals %>% round(3))
```


#### LogF2B_Ratio
```{r}
LogF2B_Ratio_rank_all = lm(
  paste0('rank(F2B_Ratio) ~ ', age_lt_90_formula_rhs) %>% as.formula,
  data=age_lt_90_master_table
  )
rank_fit_summary = summary(LogF2B_Ratio_rank_all)
# print(rank_fit_summary)

LogF2B_Ratio_rank_pvals = sapply(names(amd_only_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

F2B_Ratio_rank_pvals = c(list(Index='Age_lt_90_LogF2B_Ratio_Rank'), LogF2B_Ratio_rank_pvals)

age_lt_90_regression_stats %<>%
  add_row(!!!LogF2B_Ratio_rank_pvals)

```



#### FB_Index
```{r}
FB_Index_rank_all = lm(
  paste0('rank(F2B_Ratio) ~ ', age_lt_90_formula_rhs) %>% as.formula,
  data=age_lt_90_master_table
  )
rank_fit_summary = summary(FB_Index_rank_all)
# print(rank_fit_summary)

FB_Index_rank_pvals = sapply(names(amd_only_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

F2B_Ratio_rank_pvals = c(list(Index='Age_lt_90_FB_Index_Rank'), FB_Index_rank_pvals)

age_lt_90_regression_stats %<>%
  add_row(!!!FB_Index_rank_pvals)

```


### AMD Only

#### Firmicutes
```{r}
firmicutes_rank_all = lm(
  paste0('rank(Firmicutes) ~ ', amd_only_formula_rhs) %>% as.formula,
  data=amd_only_master_table
  )
rank_fit_summary = summary(firmicutes_rank_all)
# print(rank_fit_summary)

firmicutes_rank_pvals = sapply(names(amd_only_variables), function(name)
  {
    print(name)
    contrast_name = pval_names[[name]]
    print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
)

firmicutes_rank_pvals = c(list(Index='AMD_Only_Firmicutes_Rank'), firmicutes_rank_pvals)

amd_only_regression_stats %<>%
  add_row(!!!firmicutes_rank_pvals)


# kable(bacteroidetes_all_pvals %>% round(3))
```

#### Bacteroidetes
```{r}
bacteroidetes_rank_all = lm(
  paste0('rank(Bacteroidetes) ~ ', amd_only_formula_rhs) %>% as.formula,
  data=amd_only_master_table
  )
rank_fit_summary = summary(bacteroidetes_rank_all)
print(rank_fit_summary)

bacteroidetes_rank_pvals = sapply(names(amd_only_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

bacteroidetes_rank_pvals = c(list(Index='AMD_Only_Bacteroidetes_Rank'), bacteroidetes_rank_pvals)

amd_only_regression_stats %<>%
  add_row(!!!bacteroidetes_rank_pvals)

# kable(bacteroidetes_all_pvals %>% round(3))
```

#### F2B_Ratio
```{r}
F2B_Ratio_rank_all = lm(
  paste0('rank(F2B_Ratio) ~ ', amd_only_formula_rhs) %>% as.formula,
  data=amd_only_master_table
  )
rank_fit_summary = summary(F2B_Ratio_rank_all)
# print(rank_fit_summary)

F2B_Ratio_rank_pvals = sapply(names(amd_only_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

F2B_Ratio_rank_pvals = c(list(Index='AMD_Only_F2B_Ratio_Rank'), F2B_Ratio_rank_pvals)

amd_only_regression_stats %<>%
  add_row(!!!F2B_Ratio_rank_pvals)


# kable(bacteroidetes_all_pvals %>% round(3))
```


#### LogF2B_Ratio
```{r}
LogF2B_Ratio_rank_all = lm(
  paste0('rank(F2B_Ratio) ~ ', amd_only_formula_rhs) %>% as.formula,
  data=amd_only_master_table
  )
rank_fit_summary = summary(LogF2B_Ratio_rank_all)
# print(rank_fit_summary)

LogF2B_Ratio_rank_pvals = sapply(names(amd_only_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

F2B_Ratio_rank_pvals = c(list(Index='AMD_Only_LogF2B_Ratio_Rank'), LogF2B_Ratio_rank_pvals)

amd_only_regression_stats %<>%
  add_row(!!!LogF2B_Ratio_rank_pvals)

```


#### FB_Index
```{r}
FB_Index_rank_all = lm(
  paste0('rank(F2B_Ratio) ~ ', amd_only_formula_rhs) %>% as.formula,
  data=amd_only_master_table
  )
rank_fit_summary = summary(FB_Index_rank_all)
# print(rank_fit_summary)

FB_Index_rank_pvals = sapply(names(amd_only_variables), function(name)
  {
    # print(name)
    contrast_name = pval_names[[name]]
    # print(contrast_name)
    rank_fit_summary$coefficients[[contrast_name, 'Pr(>|t|)']]
    
  }, 
  simplify=F, 
  USE.NAMES=T
) %>% data.frame()

F2B_Ratio_rank_pvals = c(list(Index='AMD_Only_FB_Index_Rank'), FB_Index_rank_pvals)

amd_only_regression_stats %<>%
  add_row(!!!FB_Index_rank_pvals)

```


### Combine regression stats
```{r}
unadjusted_regression_stats = 
  regression_stats %>%
  add_row(!!!all_regression_stats) %>%
  add_row(!!!age_lt_90_regression_stats) %>%
  add_row(!!!amd_only_regression_stats)

adjusted_regression_stats =
  regression_stats %>%
  add_row(!!!
    all_regression_stats %>% 
      mutate_at(vars(-Index), list(~p.adjust(., method='fdr')))
  ) %>%
  add_row(!!!
    age_lt_90_regression_stats %>% 
      mutate_at(vars(-Index), list(~p.adjust(., method='fdr')))
  ) %>%
  add_row(!!!
    amd_only_regression_stats %>% 
      mutate_at(vars(-Index), list(~p.adjust(., method='fdr')))
  )
```


```{r}
print(regression_stats)

print(adjusted_regression_stats)
kable(unadjusted_regression_stats, format='html', digits=3) %>% kable_styling(full_width=T)
```

### Write Tables
```{r}
regression_stats = createWorkbook()
addWorksheet(regression_stats, sheetName="Unadjusted P-Values")
openxlsx::writeData(regression_stats, sheet="Unadjusted P-Values", unadjusted_regression_stats)
addWorksheet(regression_stats, sheetName="Adjusted P-Values")
openxlsx::writeData(regression_stats, sheet="Adjusted P-Values", adjusted_regression_stats)

filename = file.path(tables_dir, 'miseq-239_f_b_regression_stats.xlsx')

saveWorkbook(regression_stats, file=filename, overwrite=T)
```



